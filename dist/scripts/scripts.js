"use strict";angular.module("AMC-web",["ui.router","ngAnimate","ngTagsInput"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/dashboard","/dashboard/create"),t.otherwise("/login"),e.state("base",{"abstract":!0,url:"",templateUrl:"views/base.html"}).state("login",{url:"/login",parent:"base",templateUrl:"views/login.html",controller:"LoginCtrl"}).state("register",{url:"/register",parent:"base",templateUrl:"views/register.html",controller:"LoginCtrl"}).state("dashboard",{url:"/dashboard",parent:"base",templateUrl:"views/dashboard.html",controller:"DashboardCtrl"}).state("create",{url:"/create",parent:"dashboard",templateUrl:"views/dashboard/create.html",controller:"MainCtrl"}).state("list",{url:"/list",parent:"dashboard",templateUrl:"views/dashboard/list.html",controller:"MainCtrl",resolve:{postPromise:["questions",function(e){return e.getAll()}]}}).state("question",{url:"/question/{questionId}",parent:"dashboard",templateUrl:"views/dashboard/question.html",controller:"QuestionsCtrl",resolve:{question:["questions","$stateParams",function(e,t){return e.get(t.questionId)}]}}).state("test",{url:"/test",parent:"dashboard",templateUrl:"views/dashboard/test.html",controller:"TestsCtrl"})}]),angular.module("AMC-web").controller("DashboardCtrl",["$scope","$state",function(e,t){e.$state=t}]),angular.module("AMC-web").controller("LoginCtrl",["$scope","$location","auth",function(e,t,r){e.user={},e.register=function(){r.register(e.user).error(function(t){e.error=t}).then(function(){t.path("/dashboard")})},e.logIn=function(){r.logIn(e.user).error(function(t){e.error=t}).then(function(){t.path("/dashboard")})}}]),angular.module("AMC-web").controller("MainCtrl",["$scope","$http","questions","auth","tags",function(e,t,r,n,s){function o(e){var t=[];for(var r in e){var n=e[r];s.createTag(n),t.push(n.name)}return t}function a(){var t=[];if("Vrai/Faux"===e.questionType)t.push("Vrai"),t.push("Faux");else if("QCM"===e.questionType)for(var r in e.answers)t.push(e.answers[r].title);return t}function u(t){var r=[];if("Vrai/Faux"===e.questionType)r.push(e.vfAnswer);else if("QCM"===e.questionType)for(var n in t){var s=t[n];"Juste"===s.correct&&r.push(n)}return r}e.questions=r.questions,e.isLoggedIn=n.isLoggedIn,e.currentUser=n.currentUser,e.tags=[],e.sortType="seconds",e.sortReverse=!0,e.searchString="",e.questionTypes=["QCM","Vrai/Faux","Question ouverte"],e.questionType="",e.answers=[],e.answer={title:"",correct:"Fausse"},e.ddSelectType=function(t){e.questionType=t},e.addQuestion=function(){r.create({title:e.title,author:n.currentUser().username,"public":!1,date:e.localeDate(),seconds:new Date,tags:o(e.tags),type:e.questionType,answers:a(e.answers),corrects:u(e.answers)}).error(function(t){e.error=t}),e.title="",e.tags=[],e.answers=[]},e.addAnswer=function(){e.answer.title&&""!==e.answer.title&&(e.answers.push(e.answer),e.answer={title:"",correct:"Fausse"})},e.removeQuestion=function(t){r.remove(t);var n=e.questions.indexOf(t);n>-1&&e.questions.splice(n,1)},e.loadTags=function(e){return t.get("/tags/"+e)},e.localeDate=function(){var e=new Date,t=("0"+e.getDate()).slice(-2),r=("0"+(e.getMonth()+1)).slice(-2),n=e.getFullYear(),s=("0"+e.getHours()).slice(-2),o=("0"+e.getMinutes()).slice(-2);return t+"/"+r+"/"+n+" Ã  "+s+":"+o},e.searchFilter=function(t){var r=new RegExp(e.searchString,"i");return!e.searchString||r.test(t.title)||r.test(t.tags)||r.test(t.date)||r.test(t.type)},$(":input").not("textarea").not("button").keypress(function(e){return 13!==e.keyCode})}]),angular.module("AMC-web").controller("QuestionsCtrl",["$scope","questions","question","auth",function(e,t,r,n){e.question=r,e.isLoggedIn=n.isLoggedIn}]),angular.module("AMC-web").controller("TestsCtrl",["$scope",function(e){e.hello="Hello World !"}]),angular.module("AMC-web").factory("auth",["$http","$window",function(e,t){var r={};return r.saveToken=function(e){t.localStorage["amc-web-token"]=e},r.getToken=function(){return t.localStorage["amc-web-token"]},r.isLoggedIn=function(){var e=r.getToken();if(e){var n=JSON.parse(t.atob(e.split(".")[1]));return n.exp>Date.now()/1e3}return!1},r.currentUser=function(){if(r.isLoggedIn()){var e=r.getToken(),n=JSON.parse(t.atob(e.split(".")[1]));return n}},r.register=function(t){return e.post("/register",t).success(function(e){r.saveToken(e.token)})},r.logIn=function(t){return e.post("http://localhost:3000/login",t).success(function(e){r.saveToken(e.token)})},r.logOut=function(){t.localStorage.removeItem("amc-web-token")},r}]),angular.module("AMC-web").factory("questions",["$http","auth",function(e,t){var r={questions:[]};return r.getAll=function(){return e.get("/questions").success(function(e){angular.copy(e,r.questions)})},r.create=function(n){return e.post("/questions",n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){r.questions.push(e)})},r.remove=function(r){return e.put("/questions/"+r._id+"/remove",null,{headers:{Authorization:"Bearer "+t.getToken()}})},r.get=function(t){return e.get("/questions/"+t).then(function(e){return e.data})},r}]),angular.module("AMC-web").factory("tags",["$http","auth",function(e,t){var r={allTags:[]};return e.get("/tags").success(function(e){for(var t in e)r.allTags[t]=e[t].name}),r.createTag=function(n){var s=r.allTags.indexOf(n.name)>-1;s||e.post("/tags",n,{headers:{Authorization:"Bearer "+t.getToken()}})},r}]);